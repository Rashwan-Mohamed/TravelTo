import { useDispatch, useSelector } from 'react-redux/es/exports'
import React, { useState } from 'react'
import { Link, useNavigate } from 'react-router-dom'
import { useParams } from 'react-router-dom'
import { useEffect } from 'react'
import { fetchDestination } from './destionationsSlice'
import icons from '../../data'
import Weather from './Weather'
import Gallery from './Gallery'
import Photo from './Photo'

//addjust mobil;e view!
//

function Destination() {
  const [name, setName] = useState('')
  const [forecast, setForecast] = useState()
  const [photos, setPhotos] = useState()
  const [visible, setVisible] = useState(false)
  const navigate = useNavigate()
  const dispatch = useDispatch()
  const { id } = useParams()
  const status = useSelector((state) => state.destionations.status)
  const der = useSelector((state) => state.destionations.response)
  console.log(status)

  const toggleVisible = () => {
    const scrolled = document.documentElement.scrollTop
    if (scrolled > 300) {
      setVisible(true)
    } else {
      setVisible(false)
    }
  }

  useEffect(() => {
    window.addEventListener('scroll', toggleVisible)

    return () => window.removeEventListener('scroll', toggleVisible)
  }, [])
  const scrollToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth',
    })
  }

  const getPhotos = async (name) => {
    try {
      const response = await fetch(
        `https://api.unsplash.com/search/photos?query=${name}&page=1&per_page=5&orientation=portrait&client_id=${process.env.REACT_APP_UNSPLASH_KEY}`
      )
      const data = await response.json()
      setPhotos(() =>
        data.results.slice(0, 3).map((item) => {
          return <Photo key={item.id} item={item}></Photo>
        })
      )
    } catch (error) {
      console.log(error)
    }
  }

  const getWeather = async () => {
    try {
      let url = `https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/${location}?key=${process.env.REACT_APP_VISUALCROSSING}`
      const response = await fetch(url)
      const ans = await response.json()
      setForecast(ans)
    } catch (error) {
      console.log(error)
      setForecast('error')
    }
  }

  useEffect(() => {
    dispatch(fetchDestination(id))
  }, [id])

  useEffect(() => {
    if (status === 'success') {
      const { attributes, included } = der.data
      getPhotos(attributes.long_name)
      setName(attributes.long_name)
      getWeather()
      console.log(der, 'here is der')
    }
  }, [status, id])
  if (status === 'loading' || status === 'idle') return <h1>Loading...</h1>

  if (status === ('rejected' || 'error'))
    return (
      <>
        <section className='error'>
          <h1>Failed to Load.</h1>
          <Link to='/'>back to home page</Link>
        </section>
      </>
    )

  const {
    data: {
      attributes,
      relationships: { country, continent },
      relationships,
    },
    included,
  } = der
  const {
    airbnb_url,
    average_rating,
    budget,
    covid,
    getyourguide_url,
    google_events_url,
    destination_type,
    long_name,
    safety,
    latitude,
    longitude,
    url,
    population,
  } = attributes
  const known = []
  if (relationships.known_for.data.length > 0) {
    relationships.known_for.data.forEach((item) => {
      included.forEach((hero) => {
        if (item.id === hero.id && hero.attributes.slug !== 'lgbt-friendly') {
          let newHero = { ...hero }
          icons.find((icon) => {
            let newIcon = icon.split(/\//)
            let pattern = new RegExp(newHero.attributes.slug)
            if (pattern.test(newIcon[2])) {
              return (newHero.img = icon)
            }
            return ''
          })

          known.push(newHero)
        }
      })
    })
  }
  let contentE
  included.map((item) => {
    if (item.id === continent.data.id) {
      return (contentE = <h1>Content: {item.attributes.long_name}</h1>)
    }
    return ''
  })

  let safe, budge, covi
  if (destination_type !== 'Continent') {
    if (Object.values(safety).length > 0) {
      const { subText, text } = Object.values(safety)[0]
      safe = <h1>safety : {`${text}, ${subText}`}</h1>
    }
    if (Object.values(covid).length > 0) {
      const { text: covidText, url: covidUrl } = Object.values(covid)[0]
      covi = (
        <h1>
          Covid-Status : {`${covidText}, `}
          <a target={'_blank'} href={covidUrl} rel='noreferrer'>
            for more
          </a>
        </h1>
      )
    }
    if (Object.values(budget).length > 0) {
      const { subText: budgetSubtext, text: budgetText } =
        Object.values(budget)[0]
      budge = <h1>Budget $ : {`${budgetText}, ${budgetSubtext}`}</h1>
    }
  }
  const location = `${latitude},${longitude}`
  return (
    <section className='single-destination'>
      <span
        onClick={scrollToTop}
        style={{ display: visible ? 'flex' : 'none' }}
        className='toTop'
      >
        toTop
      </span>
      <section className='photos-container'>
        <h1 className=' header-title-single'>{name}</h1>
        <button onClick={() => navigate('..')} className='goBack-home'>
          Go Back
        </button>
        {photos}
      </section>
      <section className='attributes-container'>
        <article className='details'>
          <h1>{long_name}</h1>
          {attributes.capital && <h1>Capital: {attributes.capital}</h1>}
          {destination_type !== 'Continent' && contentE}
          {average_rating > 0 && (
            <h3> average rating : {average_rating.toFixed(1)}</h3>
          )}
          {safe}
          {budge}
          {covi}
        </article>

        {known.length > 0 && (
          <ul>
            <h1>Known for</h1>
            <div className='knowns'>
              {known.map((item) => {
                const {
                  img,
                  attributes: { name, slug },
                } = item

                return (
                  <li key={img}>
                    {name}
                    <img src={img} alt={name} />
                    {/* {slug} */}
                  </li>
                )
              })}
            </div>
          </ul>
        )}
        <div className='links-container'>
          <h1>External Links</h1>
          <article className='links'>
            {' '}
            <a
              target={'_blank'}
              href={airbnb_url}
              alt='airbnb'
              rel='noreferrer'
            >
              <svg
                version='1.1'
                id='Layer_1'
                xmlns='http://www.w3.org/2000/svg'
                x='0px'
                y='0px'
                viewBox='0 0 320.1 99.9'
                enableBackground='new 0 0 320.1 99.9'
              >
                <path
                  fill='#FF5A5F'
                  d='M168.7,25.1c0,3.6-2.9,6.5-6.5,6.5s-6.5-2.9-6.5-6.5s2.8-6.5,6.5-6.5C165.9,18.7,168.7,21.6,168.7,25.1z
	 M141.9,38.2c0,0.6,0,1.6,0,1.6s-3.1-4-9.7-4c-10.9,0-19.4,8.3-19.4,19.8c0,11.4,8.4,19.8,19.4,19.8c6.7,0,9.7-4.1,9.7-4.1v1.7
	c0,0.8,0.6,1.4,1.4,1.4h8.1V36.8c0,0-7.4,0-8.1,0C142.5,36.8,141.9,37.5,141.9,38.2z M141.9,62.3c-1.5,2.2-4.5,4.1-8.1,4.1
	c-6.4,0-11.3-4-11.3-10.8s4.9-10.8,11.3-10.8c3.5,0,6.7,2,8.1,4.1V62.3z M157.4,36.8h9.6v37.6h-9.6V36.8z M300.8,35.8
	c-6.6,0-9.7,4-9.7,4V18.7h-9.6v55.7c0,0,7.4,0,8.1,0c0.8,0,1.4-0.7,1.4-1.4v-1.7l0,0c0,0,3.1,4.1,9.7,4.1c10.9,0,19.4-8.4,19.4-19.8
	C320.1,44.2,311.6,35.8,300.8,35.8z M299.2,66.3c-3.7,0-6.6-1.9-8.1-4.1V48.8c1.5-2,4.7-4.1,8.1-4.1c6.4,0,11.3,4,11.3,10.8
	S305.6,66.3,299.2,66.3z M276.5,52.1v22.4h-9.6V53.2c0-6.2-2-8.7-7.4-8.7c-2.9,0-5.9,1.5-7.8,3.7v26.2h-9.6V36.8h7.6
	c0.8,0,1.4,0.7,1.4,1.4v1.6c2.8-2.9,6.5-4,10.2-4c4.2,0,7.7,1.2,10.5,3.6C275.2,42.2,276.5,45.8,276.5,52.1z M218.8,35.8
	c-6.6,0-9.7,4-9.7,4V18.7h-9.6v55.7c0,0,7.4,0,8.1,0c0.8,0,1.4-0.7,1.4-1.4v-1.7l0,0c0,0,3.1,4.1,9.7,4.1c10.9,0,19.4-8.4,19.4-19.8
	C238.2,44.2,229.7,35.8,218.8,35.8z M217.2,66.3c-3.7,0-6.6-1.9-8.1-4.1V48.8c1.5-2,4.7-4.1,8.1-4.1c6.4,0,11.3,4,11.3,10.8
	S223.6,66.3,217.2,66.3z M191.2,35.8c2.9,0,4.4,0.5,4.4,0.5v8.9c0,0-8-2.7-13,3v26.3h-9.6V36.8c0,0,7.4,0,8.1,0
	c0.8,0,1.4,0.7,1.4,1.4v1.6C184.3,37.7,188.2,35.8,191.2,35.8z M91.5,71c-0.5-1.2-1-2.5-1.5-3.6c-0.8-1.8-1.6-3.5-2.3-5.1l-0.1-0.1
	c-6.9-15-14.3-30.2-22.1-45.2l-0.3-0.6c-0.8-1.5-1.6-3.1-2.4-4.7c-1-1.8-2-3.7-3.6-5.5C56,2.2,51.4,0,46.5,0c-5,0-9.5,2.2-12.8,6
	c-1.5,1.8-2.6,3.7-3.6,5.5c-0.8,1.6-1.6,3.2-2.4,4.7l-0.3,0.6C19.7,31.8,12.2,47,5.3,62l-0.1,0.2c-0.7,1.6-1.5,3.3-2.3,5.1
	c-0.5,1.1-1,2.3-1.5,3.6c-1.3,3.7-1.7,7.2-1.2,10.8c1.1,7.5,6.1,13.8,13,16.6c2.6,1.1,5.3,1.6,8.1,1.6c0.8,0,1.8-0.1,2.6-0.2
	c3.3-0.4,6.7-1.5,10-3.4c4.1-2.3,8-5.6,12.4-10.4c4.4,4.8,8.4,8.1,12.4,10.4c3.3,1.9,6.7,3,10,3.4c0.8,0.1,1.8,0.2,2.6,0.2
	c2.8,0,5.6-0.5,8.1-1.6c7-2.8,11.9-9.2,13-16.6C93.2,78.2,92.8,74.7,91.5,71z M46.4,76.2c-5.4-6.8-8.9-13.2-10.1-18.6
	c-0.5-2.3-0.6-4.3-0.3-6.1c0.2-1.6,0.8-3,1.6-4.2c1.9-2.7,5.1-4.4,8.8-4.4c3.7,0,7,1.6,8.8,4.4c0.8,1.2,1.4,2.6,1.6,4.2
	c0.3,1.8,0.2,3.9-0.3,6.1C55.3,62.9,51.8,69.3,46.4,76.2z M86.3,80.9c-0.7,5.2-4.2,9.7-9.1,11.7c-2.4,1-5,1.3-7.6,1
	c-2.5-0.3-5-1.1-7.6-2.6c-3.6-2-7.2-5.1-11.4-9.7c6.6-8.1,10.6-15.5,12.1-22.1c0.7-3.1,0.8-5.9,0.5-8.5c-0.4-2.5-1.3-4.8-2.7-6.8
	c-3.1-4.5-8.3-7.1-14.1-7.1s-11,2.7-14.1,7.1c-1.4,2-2.3,4.3-2.7,6.8c-0.4,2.6-0.3,5.5,0.5,8.5c1.5,6.6,5.6,14.1,12.1,22.2
	c-4.1,4.6-7.8,7.7-11.4,9.7c-2.6,1.5-5.1,2.3-7.6,2.6c-2.7,0.3-5.3-0.1-7.6-1c-4.9-2-8.4-6.5-9.1-11.7c-0.3-2.5-0.1-5,0.9-7.8
	c0.3-1,0.8-2,1.3-3.2c0.7-1.6,1.5-3.3,2.3-5l0.1-0.2c6.9-14.9,14.3-30.1,22-44.9l0.3-0.6c0.8-1.5,1.6-3.1,2.4-4.6
	c0.8-1.6,1.7-3.1,2.8-4.4c2.1-2.4,4.9-3.7,8-3.7c3.1,0,5.9,1.3,8,3.7c1.1,1.3,2,2.8,2.8,4.4c0.8,1.5,1.6,3.1,2.4,4.6l0.3,0.6
	C67.7,34.8,75.1,50,82,64.9L82,65c0.8,1.6,1.5,3.4,2.3,5c0.5,1.2,1,2.2,1.3,3.2C86.4,75.8,86.7,78.3,86.3,80.9z'
                />
              </svg>
            </a>
            <a
              target={'_blank'}
              rel='noreferrer'
              href={getyourguide_url}
              alt='getyourguide'
            >
              <svg
                width='256px'
                height='203px'
                viewBox='0 0 256 203'
                version='1.1'
                xmlns='http://www.w3.org/2000/svg'
                preserveAspectRatio='xMidYMid'
              >
                <g>
                  <path
                    d='M58.7693166,91.1888424 C58.7693166,87.1185495 61.9112971,84.1193863 65.8387727,84.1193863 C69.7662483,84.1193863 72.9082287,87.1899582 72.9082287,91.1888424 C72.9082287,95.2591353 69.7662483,98.2582985 65.8387727,98.2582985 C61.9112971,98.2582985 58.7693166,95.1877266 58.7693166,91.1888424 Z M71.3372385,78.4781032 C71.3372385,82.5483961 74.479219,85.5475593 78.4066946,85.5475593 C82.3341702,85.5475593 85.4761506,82.4769874 85.4761506,78.4781032 C85.4761506,74.4078103 82.3341702,71.4086471 78.4066946,71.4086471 C74.479219,71.4086471 71.3372385,74.4078103 71.3372385,78.4781032 Z M88.5467225,69.8376569 L88.5467225,82.5483961 C98.4725244,82.5483961 106.256067,90.6175732 106.256067,101.186053 C106.256067,111.754533 98.4011158,119.82371 88.5467225,119.82371 C78.6209205,119.82371 70.837378,111.754533 70.837378,101.186053 L56.9841004,101.186053 C56.9841004,118.75258 70.9801953,132.534449 88.5467225,132.534449 C106.11325,132.534449 120.109344,118.75258 120.109344,101.186053 C120.109344,83.6195258 106.11325,69.8376569 88.5467225,69.8376569 Z M231.006974,189.018689 L231.006974,176.950628 L253.35788,176.950628 L253.35788,164.882566 L231.006974,164.882566 L231.006974,153.028731 L255.642957,153.028731 L255.642957,140.889261 L217.439331,140.889261 L217.439331,201.08675 L256,201.08675 L256,188.94728 L231.006974,188.94728 L231.006974,189.018689 Z M209.370153,171.02371 C209.370153,188.304603 196.159554,201.08675 177.521897,201.08675 L157.670293,201.08675 L157.670293,140.817852 L177.521897,140.817852 C196.159554,140.817852 209.370153,153.742817 209.370153,171.02371 Z M195.516876,171.02371 C195.516876,160.740865 188.661646,152.957322 178.593026,152.957322 L171.166527,152.957322 L171.166527,189.018689 L178.593026,189.018689 C188.661646,189.018689 195.516876,181.306555 195.516876,171.02371 Z M104.899303,177.950349 C104.899303,184.876987 99.972106,190.01841 93.1882845,190.01841 C86.404463,190.01841 81.4772664,184.876987 81.4772664,177.950349 L81.4772664,140.960669 L68.0524407,140.960669 L68.0524407,177.736123 C68.0524407,191.946444 78.6923291,202.372106 93.1882845,202.372106 C107.68424,202.372106 118.324128,191.875035 118.324128,177.736123 L118.324128,140.960669 L104.899303,140.960669 L104.899303,177.950349 L104.899303,177.950349 Z M26.7782427,179.164296 L40.1316597,179.164296 C38.9177127,185.376848 33.4192469,190.161227 26.8496513,190.161227 C19.4945607,190.161227 13.567643,184.23431 13.567643,175.593863 L13.567643,166.667782 C13.567643,158.170153 19.9230126,151.886192 28.8490934,151.886192 C35.7757322,151.886192 41.9882845,155.670851 43.9877266,161.169317 L56.4842399,156.813389 C53.0566248,146.244909 41.7740586,139.675314 28.8490934,139.675314 C12.4965132,139.675314 0.357043236,150.672245 0.357043236,166.667782 L0.357043236,175.593863 C0.428451883,190.946722 11.7824268,202.372106 25.7785216,202.372106 C34.4903766,202.372106 42.2025105,197.94477 46.7012552,191.08954 L46.7012552,201.158159 L58.5550907,201.158159 L58.5550907,167.667503 L26.7782427,167.667503 L26.7782427,179.164296 Z M178.664435,107.827057 L178.664435,71.0516039 L165.239609,71.0516039 L165.239609,108.041283 C165.239609,114.967922 160.312413,120.109344 153.528591,120.109344 C146.74477,120.109344 141.817573,114.967922 141.817573,108.041283 L141.817573,71.0516039 L128.392748,71.0516039 L128.392748,107.827057 C128.392748,122.037378 139.032636,132.46304 153.528591,132.46304 C168.024547,132.46304 178.664435,122.037378 178.664435,107.827057 Z M22.7079498,131.249093 L36.2041841,131.249093 L36.2041841,108.398326 L58.8407252,71.0516039 L43.5592748,71.0516039 L29.2775453,95.6875872 L15.2100418,71.0516039 L0,71.0516039 L22.6365411,108.541144 L22.6365411,131.249093 L22.7079498,131.249093 Z M158.312971,1.14253835 L112.611437,1.14253835 L112.611437,13.2820084 L158.312971,13.2820084 L158.312971,1.14253835 Z M106.827336,49.2005579 L81.762901,49.2005579 L81.762901,37.1324965 L104.113808,37.1324965 L104.113808,25.0644351 L81.762901,25.0644351 L81.762901,13.2105997 L106.398884,13.2105997 L106.398884,1.07112971 L68.195258,1.07112971 L68.195258,61.2686192 L106.755927,61.2686192 L106.755927,49.2005579 L106.827336,49.2005579 Z M25.7785216,62.6253835 C34.4903766,62.6253835 42.2025105,58.1980474 46.7012552,51.3428173 L46.7012552,61.4114365 L58.5550907,61.4114365 L58.5550907,27.920781 L26.7782427,27.920781 L26.7782427,39.4889819 L40.1316597,39.4889819 C38.9177127,45.7015342 33.4192469,50.4859135 26.8496513,50.4859135 C19.4945607,50.4859135 13.567643,44.5589958 13.567643,35.9185495 L13.567643,26.9924686 C13.567643,18.4948396 19.9230126,12.2108787 28.8490934,12.2108787 C35.7757322,12.2108787 41.9882845,15.995537 43.9877266,21.4940028 L56.4842399,17.1380753 C53.0566248,6.56959554 41.7740586,0 28.8490934,0 C12.4965132,0 0.357043236,10.9969317 0.357043236,26.9924686 L0.357043236,35.9185495 C0.428451883,51.2 11.7824268,62.6253835 25.7785216,62.6253835 Z M209.441562,116.039052 L202.443515,108.683961 L209.370153,101.186053 L202.372106,93.8309623 L209.298745,86.3330544 L202.300697,78.9779637 L210.012831,71.0516039 L196.016736,71.0516039 L188.44742,79.0493724 L195.445467,86.404463 L188.518828,93.902371 L195.516876,101.257462 L188.590237,108.75537 L195.588285,116.11046 L188.661646,123.608368 L196.088145,131.320502 L210.155649,131.320502 L202.586332,123.53696 L209.441562,116.039052 Z M143.817015,169.238494 C145.816457,167.453278 149.172664,164.454114 149.172664,158.88424 C149.172664,153.385774 145.816457,150.315202 143.817015,148.529986 C143.745607,148.458577 143.674198,148.387169 143.602789,148.31576 C142.603068,147.24463 142.460251,145.745049 142.388842,145.030962 L142.388842,140.817852 L128.821199,140.817852 L128.821199,146.459135 L128.821199,146.459135 C128.821199,146.530544 128.821199,146.601953 128.821199,146.673361 C128.821199,152.171827 132.177406,155.242399 134.176848,157.027615 C135.605021,158.312971 135.605021,158.384379 135.605021,158.88424 C135.605021,159.3841 135.605021,159.455509 134.176848,160.740865 C132.248815,162.454672 129.106834,165.311018 128.892608,170.452441 L128.892608,170.452441 C128.892608,170.523849 128.892608,170.666667 128.892608,170.738075 C128.892608,170.809484 128.892608,170.809484 128.892608,170.880893 C128.892608,170.952301 128.892608,170.952301 128.892608,171.02371 C128.892608,171.095119 128.892608,171.237936 128.892608,171.309344 L128.892608,171.309344 C129.106834,176.450767 132.320223,179.307113 134.176848,181.020921 C135.605021,182.306276 135.605021,182.377685 135.605021,182.877545 C135.605021,183.377406 135.605021,183.448815 134.176848,184.73417 C132.177406,186.519386 128.821199,189.51855 128.821199,195.088424 C128.821199,195.159833 128.821199,195.231241 128.821199,195.30265 L128.821199,195.30265 L128.821199,200.943933 L142.388842,200.943933 L142.388842,196.730823 C142.388842,196.016736 142.603068,194.517155 143.602789,193.446025 C143.674198,193.374616 143.745607,193.303208 143.817015,193.231799 C145.816457,191.446583 149.172664,188.44742 149.172664,182.877545 C149.172664,177.379079 145.816457,174.308508 143.817015,172.523291 C142.53166,171.380753 142.388842,171.166527 142.388842,170.809484 C142.460251,170.595258 142.603068,170.381032 143.817015,169.238494 Z M128.678382,61.3400279 L142.174616,61.3400279 L142.174616,50.1288703 L128.678382,50.1288703 L128.678382,61.3400279 Z M142.246025,34.1333333 L128.749791,34.1333333 L128.749791,45.3444909 L142.246025,45.3444909 L142.246025,34.1333333 Z M142.246025,18.0663877 L128.749791,18.0663877 L128.749791,29.2775453 L142.246025,29.2775453 L142.246025,18.0663877 Z M244.574616,131.249093 L228.150628,108.255509 C236.148396,105.756206 241.718271,98.758159 241.718271,90.1891213 C241.718271,79.335007 232.720781,71.0516039 221.366806,71.0516039 L213.440446,71.0516039 L213.440446,83.2624826 L220.866946,83.2624826 C224.794421,83.2624826 227.864993,86.404463 227.864993,90.5461646 C227.864993,94.6878661 224.794421,97.8298466 220.866946,97.8298466 L213.440446,97.8298466 L213.440446,109.398047 L228.150628,131.320502 L244.574616,131.320502 L244.574616,131.249093 Z'
                    fill='#FF5533'
                  ></path>
                </g>
              </svg>
            </a>
            <a target={'_blank'} rel='noreferrer' href={google_events_url}>
              <img src='images/1534129544.png' alt='google_events' />
              <p>Google events</p>
            </a>
            <a target={'_blank'} rel='noreferrer' href={url}>
              <img src='images/goatmascot.png' alt='RoadGoat' />
              <p>more info</p>
            </a>
          </article>
        </div>

        <Weather forecast={forecast}></Weather>
      </section>
      <Gallery name={name} />
    </section>
  )
}

export default Destination
